<!doctype html>
<title>source-vs-npm audit results</title>
<style>
  table {
    border-collapse: collapse;
  }
  table,
  td,
  th {
    border: 1px solid black;
  }
</style>
<h4>Stats:</h4>
<ul id="statsList"></ul>
<table>
  <thead>
    <tr>
      <th>Package</th>
      <!-- TODO: <th>Author</th> -->
      <!-- TODO: <th>Repo</th> -->
      <!-- TODO: <th>Published</th> TODO: published date -->
      <th>Version</th>
      <th>Audit time</th>
      <th>Result</th>
      <!-- TODO: <th>Notes</th> TODO: tags with explanations on hover -->
      <th><!-- View log button --></th>
    </tr>
  </thead>
  <tbody id="resultsTableBody"></tbody>
</table>
<script>
  const results = PLACEHOLDER;

  // Populate stats:
  const stats = {};
  for (const pkg of results) {
    if (pkg.contentMatches) {
      stats["Pass"] = (stats["Pass"] || 0) + 1;
    } else if (pkg.contentMatches === false && pkg.isKnownBenignMismatch) {
      stats["Benign mismatch"] = (stats["Benign mismatch"] || 0) + 1;
    } else if (pkg.contentMatches === false) {
      stats["Mismatch"] = (stats["Mismatch"] || 0) + 1;
    } else {
      stats[pkg.errorCategory] = (stats[pkg.errorCategory] || 0) + 1;
    }
  }
  for (const [result, count] of Object.entries(stats).sort(
    (stat1, stat2) => stat2[1] - stat1[1],
  )) {
    const ul = document.createElement("ul");
    ul.textContent = `${result}: ${count}`;
    statsList.appendChild(ul);
  }

  // Populate table:
  const tbody = document.createElement("tbody");
  for (const pkg of results) {
    const tr = document.createElement("tr");
    const packageTd = document.createElement("td");
    const packageLink = document.createElement("a");
    packageLink.textContent = pkg.packageName;
    packageLink.href = `https://npmjs.org/package/${pkg.packageName}`;
    packageLink.target = "_blank";
    packageTd.appendChild(packageLink);
    tr.appendChild(packageTd);
    const versionTd = document.createElement("td");
    versionTd.textContent = pkg.version;
    tr.appendChild(versionTd);
    const startTimeTd = document.createElement("td");
    startTimeTd.textContent = pkg.startTime;
    tr.appendChild(startTimeTd);
    const resultTd = document.createElement("td");
    if (pkg.contentMatches === true) {
      resultTd.textContent = "âœ“";
      tr.style.backgroundColor = "green";
    } else if (pkg.contentMatches === false && pkg.isKnownBenignMismatch) {
      resultTd.textContent = "Benign mismatch";
      tr.style.backgroundColor = "green";
    } else if (pkg.contentMatches === false) {
      resultTd.textContent = "Mismatch";
      tr.style.backgroundColor = "red";
    } else {
      resultTd.textContent = pkg.errorCategory;
      tr.style.backgroundColor = "red";
    }
    tr.appendChild(resultTd);
    const logsTd = document.createElement("td");
    const logsLink = document.createElement("a");
    logsLink.textContent = "View log";
    logsLink.href = `./audits/${pkg.packageName}/${pkg.startTime}.log`;
    logsLink.target = "_blank";
    logsTd.appendChild(logsLink);
    tr.appendChild(logsTd);
    tbody.appendChild(tr);
  }
  resultsTableBody.innerHTML = tbody.innerHTML;
</script>
