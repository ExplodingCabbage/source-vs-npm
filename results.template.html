<!doctype html>
<title>source-vs-npm audit results</title>
<style>
  table {
    border-collapse: collapse;
  }
  table,
  td,
  th {
    border: 1px solid black;
    padding: 1px;
  }
  .pill {
    display: inline-block;
    border-radius: 3px;
    margin: 0 3px;
    border: 1px solid black;
  }
</style>
<h4>Stats:</h4>
<ul id="statsList"></ul>
<table>
  <thead>
    <tr>
      <th>Package</th>
      <th>Repo</th>
      <th>Published</th>
      <th>Version</th>
      <th>Audit time</th>
      <th>Result</th>
      <th>Special traits</th>
      <th><!-- View log button --></th>
      <!-- TODO: human-written notes about individual package versions: <th>Notes</th> -->
    </tr>
  </thead>
  <tbody id="resultsTableBody"></tbody>
</table>
<script>
  const results = PLACEHOLDER;

  // Populate stats:
  const stats = {};
  for (const pkg of results) {
    if (pkg.contentMatches) {
      stats["Pass"] = (stats["Pass"] || 0) + 1;
    } else if (pkg.contentMatches === false && pkg.isKnownBenignMismatch) {
      stats["Benign mismatch"] = (stats["Benign mismatch"] || 0) + 1;
    } else if (pkg.contentMatches === false) {
      stats["Mismatch"] = (stats["Mismatch"] || 0) + 1;
    } else {
      stats[pkg.errorCategory] = (stats[pkg.errorCategory] || 0) + 1;
    }
  }
  for (const [result, count] of Object.entries(stats).sort(
    (stat1, stat2) => stat2[1] - stat1[1],
  )) {
    const ul = document.createElement("ul");
    ul.textContent = `${result}: ${count}`;
    statsList.appendChild(ul);
  }

  // Populate table:
  const tbody = document.createElement("tbody");
  for (const pkg of results) {
    const tr = document.createElement("tr");
    const packageTd = document.createElement("td");
    const packageLink = document.createElement("a");
    packageLink.textContent = pkg.packageName;
    packageLink.href = `https://npmjs.org/package/${pkg.packageName}`;
    packageLink.target = "_blank";
    packageTd.appendChild(packageLink);
    tr.appendChild(packageTd);
    const repoUrlTd = document.createElement("td");
    if (pkg.repoUrl) {
      const repoUrlLink = document.createElement("a");
      repoUrlLink.textContent = "View repo";
      repoUrlLink.href = pkg.repoUrl;
      repoUrlLink.target = "_blank";
      repoUrlTd.appendChild(repoUrlLink);
    } else {
      repoUrlTd.textContent = "(No repo)";
    }
    tr.appendChild(repoUrlTd);
    const publishedAtTd = document.createElement("td");
    publishedAtTd.textContent = pkg.publishedAt;
    tr.appendChild(publishedAtTd);
    const versionTd = document.createElement("td");
    versionTd.textContent = pkg.version;
    tr.appendChild(versionTd);
    const startTimeTd = document.createElement("td");
    startTimeTd.textContent = pkg.startTime;
    tr.appendChild(startTimeTd);
    const resultTd = document.createElement("td");
    if (pkg.contentMatches === true) {
      resultTd.textContent = "âœ“";
      tr.style.backgroundColor = "green";
    } else if (pkg.contentMatches === false && pkg.isKnownBenignMismatch) {
      resultTd.textContent = "Benign mismatch";
      tr.style.backgroundColor = "green";
    } else if (pkg.contentMatches === false) {
      resultTd.textContent = "Mismatch";
      tr.style.backgroundColor = "red";
    } else {
      resultTd.textContent = pkg.errorCategory;
      tr.style.backgroundColor = "red";
    }
    tr.appendChild(resultTd);
    const traitsTd = document.createElement("td");
    function addPill(text, color) {
      const pill = document.createElement("div");
      pill.classList.add("pill");
      pill.textContent = text;
      pill.style.backgroundColor = color;
      traitsTd.appendChild(pill);
    }
    if (pkg.buildDetails?.usesCleanPublish) {
      addPill("clean-publish", "white");
    }
    if (pkg.buildDetails?.isPackedFromBuildDir) {
      addPill("/build", "lightsalmon");
    }
    if (pkg.buildDetails?.isReact) {
      addPill("react", "rgb(8, 126, 164)");
    }
    if (pkg.buildDetails?.isBabel) {
      addPill("babel", "#eeda7c");
    }
    if (pkg.buildDetails?.isDefinitelyTyped) {
      addPill("@types", "blue");
    }
    tr.appendChild(traitsTd);

    const logsTd = document.createElement("td");
    const logsLink = document.createElement("a");
    logsLink.textContent = "View log";
    logsLink.href = `./audits/${pkg.packageName}/${pkg.startTime}.log`;
    logsLink.target = "_blank";
    logsTd.appendChild(logsLink);
    tr.appendChild(logsTd);
    tbody.appendChild(tr);
  }
  resultsTableBody.innerHTML = tbody.innerHTML;
</script>
